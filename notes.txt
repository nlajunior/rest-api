# ambiente

alias python=python3.7

pip install virtualenv

virtualenv ambvir --python=python3.7

source db.sql executa o script

Postgresql

apt install postgresql postgresql-contrib

sudo -i -u postgres

psql
\conninfo
\q

exit

sudo -u postgress createuser ubuntu
sudo -u postgress createdb -O ubuntu ubuntu
psql
\password ubuntu
\q

sudo nano /etc/postgresql/10/main/pg_hba.conf
alterar  peer para md5
\q

pip install psycopg2-binary

string de conexÃ£o 'postgresql://ubuntu:123@localhost:5432/ubuntu'

.bashrc 
export USERDB="admindba"
export PASSWORD="123456789"
export DATABASE="db"
export JWT_SECRET_KEY="T@uT0m&r1@"


from flask_restful import Resource, reqparse
from models.test import TestModel
from flask_jwt_extended import jwt_required
from filtros import *
import mysql.connector


path_params = reqparse.RequestParser()
path_params.add_argument('token', type=str)
path_params.add_argument('fhr_valeu_min', type=float)
path_params.add_argument('fhr_valeu_max', type=float)
path_params.add_argument('limit', type=float)
path_params.add_argument('offset', type=float)

class Tests(Resource):
    def get(self):

        data = path_params.parse_args()
        data_valid = {chave:data[chave] for chave in data if data[chave] is not None}
        parametros= normalize_path_params(**data_valid)

        connection = mysql.connector.connect(user='', password='', host='', database='')

        cursor= cconnection cursor()
        
        if not parametros.get('token'):
            tupla = tuple([parametros[chave] for chave in parametros])
            cursor.execute(query_without_token, tupla)
            result = cursor.fetchall()
        else:
            tupla = tuple([parametros[chave] for chave in parametros])
            cursor.execute(query_with_token, tupla)
            result = cursor.fetchall()

        tests = []
        if result:
           for linha in result:
                tests.append({
                    'id': linha[0],
                    'duration': linha[1],
                    'fhr_value': linha[2],
                    'session_id': linha[3],
                    'date_created':linha[4] ,
                    'device_id': linha[5]
                })

        return {'tests': tests}

        #return {'tests':[test.json() for test in TestModel.query.all()]}

class Test(Resource):
    argumentos = reqparse.RequestParser()
    argumentos.add_argument('duration')
    argumentos.add_argument('fhr_valeu')
    argumentos.add_argument('token', type=str, required=True, help="This field 'token' cannot be left ")
    argumentos.add_argument('date_created')
    argumentos.add_argument('device_id')
   
    def get(self, id):
        test = TestModel.find_test(id)
        if test:
            return test.json()
        return {'message': 'Test not found'}, 404

    @jwt_required
    def  post(self, id):
        if TestModel.find_test(id):
            return {"message": "Test id '{}' already exists.".format(id)}, 400
        
        data = Test.argumentos.parse_args()
        test = TestModel(id, **data)
        try:
            test.save_test()
        except:
            return {'message': 'An internal error ocurred trying to save test'}, 500
        
        return test.json(), 200
    
    @jwt_required
    def put(self, id):
        data = Test.argumentos.parse_args()
                
        test_find = TestModel.find_test(id)
        if test_find:
            test_find.update_test(**data)
            test_find.save_test()
            return test_find.json(), 200

        test = TestModel(id, **data)
        try:
            test.save_test()
        except:
            return {'message': 'An internal error ocurred trying to save test'}, 500
        
        return test, 201

    @jwt_required
    def delete(self, id):
        test = TestModel.find_test(id)
        if test:
            try:
                test.delete_test()
            except:
                return {'message': 'An internal error ocurred trying to delete test'}, 500
            return {'message': 'Test deleted.'}

        return {'message': 'Test not deleted'}, 404




pip install --upgrade google-api-python-client google-auth-httplib2 google-auth-oauthlib


parameters = normalize_path_params(**data_valid)

        if not parameters.get('session_id'):
            tupla = tuple([parameters[chave] for chave in parameters])
            cursor.execute(query_without_token, tupla)
            result = cursor.fetchall()
        else:
            tupla = tuple([parameters[chave] for chave in parameters])
            cursor.execute(query_with_token, tupla)
            result = cursor.fetchall()
        
        tests = []
        if result:
           for linha in result:
                tests.append({
                    'id': linha[0],
                    'duration': linha[1],
                    'fhr_value': linha[2],
                    'session_id': linha[3],
                    'date_created':linha[4] ,
                    'device_id': linha[5]
                })

        return {'tests': tests}
    

    [Unit]
Description=Gunicorn instance to serve app
After=network.target

[Service]
User=ubuntu
Group=www-data
WorkingDirectory=/home/ubuntu/app
Environment="PATH=/home/ubuntu/app/venv/bin"
ExecStart=/home/ubuntu/app/venv/bin/gunicorn --workers 3 --bind 127.0.0.1:8000 app:app

[Install]
WantedBy=multi-user.target


RUN yum update -y
  7 RUN yum install python3 -y
  8 RUN yum install python3-pip -y
  9 RUN yum install python3-devel -y
 10 RUN yum install mysql -y
 11 RUN yum install mysql-devel -y
 12 RUN yum install gcc -y


 server {
    listen 9000;
    server_name 10.168.165.95;
        location / {
        proxy_pass         "http://127.0.0.1:8000";
        proxy_redirect     off;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
    }
    
}

setsebool httpd_can_network_connect on -P
Environment=PATH="/home/suporte/app/venv/bin"
ExecStart=/home/suporte/app/venv/bin/gunicorn --workers 3 --bind 127.0.0.1:8000 app:app

[Unit]
Description=Gunicorn instance to serve myproject
After=network.target

[Service]
User=root
Group=wheel
WorkingDirectory=/home/suporte/app
Environment="PATH=/home/suporte/app/venv/bin"
ExecStart=/home/suporte/app/venv/bin/gunicorn --workers 3 --bind 127.0.0.1:8000 -m 007 app:app

[Install]
WantedBy=multi-user.target


[Unit]
Description=Gunicorn instance
After=network.target

[Service]
User=suporte
Group=suporte
WorkingDirectory=/home/suporte/app
Environment="PATH=/home/suporte/app/venv/bin"
ExecStart=/home/suporte/app/venv/bin/gunicorn --workers 3 --bind 127.0.0.1:8000 -m 007 app:app

[Install]
WantedBy=multi-user.target


SELECT * FROM db.test WHERE IDENTIFIER='8C:AA:B5:85:EE:14:1' AND DATE_FORMAT(date_created, '%Y-%m-%d')='2021-01-09' AND duration>=0 AND duration<=200 ORDER BY duration 10  OFFSET 2;

explain format=json SELECT t.duration, t.fhr_value, t.identifier FROM db.test as t inner join db.monitoring as m on t.identifier=m.identifier
WHERE t.IDENTIFIER='80:7D:3A:DA:D9:F5:1' AND DATE_FORMAT(t.date_created, '%Y-%m-%d')='2020-12-15' AND t.duration>=0 AND t.duration<=200 AND m.status=1 \G

 

